<!-- TOC -->

- [èµ„æ–™](#%E8%B5%84%E6%96%99)
- [ç›®å½•ç»“æ„è®¾è®¡](#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1)
- [ctx](#ctx)
- [ä¸­é—´ä»¶](#%E4%B8%AD%E9%97%B4%E4%BB%B6)
- [route](#route)
- [errorå¤„ç†](#error%E5%A4%84%E7%90%86)
- [logger](#logger)
- [ä¼˜åŒ–éƒ¨ç½²ä¸äº‘](#%E4%BC%98%E5%8C%96%E9%83%A8%E7%BD%B2%E4%B8%8E%E4%BA%91)
  - [1. æ€§èƒ½æŒ‡æ ‡](#1-%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87)
  - [2. æ€§èƒ½æŒ‡æ ‡ä¼˜åŒ–](#2-%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87%E4%BC%98%E5%8C%96)
- [å•å…ƒæµ‹è¯•](#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95)
- [ç™»å½•](#%E7%99%BB%E5%BD%95)
- [é‰´æƒ](#%E9%89%B4%E6%9D%83)
  - [1. cookie](#1-cookie)
  - [2. session](#2-session)
  - [3. JWT](#3-jwt)
- [åŒå·¥é€šä¿¡](#%E5%8F%8C%E5%B7%A5%E9%80%9A%E4%BF%A1)
  - [1. websocket](#1-websocket)
  - [2. socket.io](#2-socketio)
  - [3. SSE](#3-sse)
  - [4. é•¿è½®è¯¢](#4-%E9%95%BF%E8%BD%AE%E8%AF%A2)
- [ä¸“é¡¹](#%E4%B8%93%E9%A1%B9)
  - [1. koa-static](#1-koa-static)
  - [2. æ–‡ä»¶ä¸Šä¼ ](#2-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0)
  - [3. å¤§æ–‡ä»¶æ–­ç‚¹ç»­ä¼ ](#3-%E5%A4%A7%E6%96%87%E4%BB%B6%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0)
    - [3.1. æ–‡ä»¶æ–­ç‚¹ç»­ä¼ ï¼šä¸‹è½½](#31-%E6%96%87%E4%BB%B6%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0%E4%B8%8B%E8%BD%BD)
    - [3.2. æ–‡ä»¶æ–­ç‚¹ç»­ä¼ ï¼šä¸Šä¼ ](#32-%E6%96%87%E4%BB%B6%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0%E4%B8%8A%E4%BC%A0)
    - [3.3. æ–­ç‚¹ç»­ä¼ ï¼šæ€»ç»“](#33-%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0%E6%80%BB%E7%BB%93)
- [DBè¿æ¥](#db%E8%BF%9E%E6%8E%A5)
  - [1. mysql](#1-mysql)
  - [2. mongoDB](#2-mongodb)
  - [3. redis](#3-redis)
- [error](#error)
- [tips](#tips)

<!-- /TOC -->
# èµ„æ–™
- ã€Škoa2ä¸Nodejså®æˆ˜ã€‹
  - https://github.com/ikcamp
# ç›®å½•ç»“æ„è®¾è®¡
```
ä»¥koa-generatorç”Ÿæˆçš„å‚è€ƒï¼šhttps://zhuanlan.zhihu.com/p/150684329
```
- app.js
- bin/www
- routes
- views
- public
- controller
- model

# ctx
- ctx.request
  - method
  - url
  - query
  - queryString
  - urlä¸­å‚æ•°è·å–: 'home/:id/:name' => ctx.params.id/name
  - postè¯·æ±‚ -> koa-bodyparser -> ctx.request.body/rawBody
  - accepts('json') // åˆ¤æ–­å®¢æˆ·ç«¯request.head.Accept
- ctx.response
  - status
  - type // response.head.conten-type
  - body
    - å½“ ctx.body è¢«èµ‹å€¼åï¼ŒKoa ä¼šç«‹å³å°†å“åº”å‘é€ç»™å®¢æˆ·ç«¯ï¼Œå¹¶ä¸”åœæ­¢ç»§ç»­è°ƒç”¨åç»­çš„ä¸­é—´ä»¶ã€‚
  - ctx.state
  - ctx.cookies
  - ctx.throw
    - å½“è°ƒç”¨ ctx.throw æ—¶ï¼ŒKoa ä¼šå°†é”™è¯¯ä¿¡æ¯å°è£…æˆä¸€ä¸ª KoaError å¯¹è±¡ï¼Œå¹¶å‘é€ç»™å®¢æˆ·ç«¯ã€‚è¿™ä¸ªå¯¹è±¡åŒ…å«äº†ä¸€äº›å…³äºé”™è¯¯çš„è¯¦ç»†ä¿¡æ¯ï¼Œä¾‹å¦‚é”™è¯¯çŠ¶æ€ç ï¼ˆstatusï¼‰ã€é”™è¯¯æ¶ˆæ¯ï¼ˆmsgï¼‰å’Œé”™è¯¯å±æ€§ï¼ˆpropertiesï¼‰ã€‚åœ¨ä¸­é—´ä»¶çš„é“¾å¼è°ƒç”¨ä¸­ï¼Œå¦‚æœæŸä¸ªä¸­é—´ä»¶è°ƒç”¨äº† ctx.throw æ–¹æ³•ï¼ŒKoa ä¼šç«‹å³ä¸­æ–­åç»­ä¸­é—´ä»¶çš„æ‰§è¡Œï¼Œå¹¶å°†é”™è¯¯ä¿¡æ¯å‘é€ç»™å®¢æˆ·ç«¯ã€‚å› æ­¤ï¼Œctx.throw ä¼šä¸­æ–­é“¾å¼è°ƒç”¨ã€‚
  - ctx.set('Content-Type', "application/json")
# ä¸­é—´ä»¶
- koa-bodyparser
```js
// koa-bodyparserå®ç°åŸç†
app.use(async (ctx, next) => {
  let postDataStr = '';
  ctx.req.on('data', data => postDataStr += data);
  ctx.req.on('end', () => ctx.request.body = JSON.parse(postDataStr));
})
```
- ä¸Šä¼ æ–‡ä»¶ï¼š@koa/multer multer
```js
app.use(koaMulter)
// route
router.get('home', controller.home);
// controller
controller.home = async (ctx, next) => {
  // ctxä¼šè°ƒç”¨ä¹‹å‰æ³¨å†Œå¥½çš„æ¨¡ç‰ˆnunjucks
  await ctx.render('home', {
    value1: 'æ’å…¥çš„å˜é‡1'
  });
}
```
- koa-json
```js
app.use(koaJson)
// koa-jsonä¼šè‡ªåŠ¨åšçš„äº‹æƒ…ï¼š
// ctx.set("Content-Type", "application/json")
// ctx.body = JSON.stringify(res)
ctx.body = { foo: 1 };
```
# route
# errorå¤„ç†
- éƒ¨åˆ†é”™è¯¯å±•ç¤ºä¸ºé”™è¯¯é¡µï¼š
```js
const nunjucks = require('nunjucks');

koaApp.on('error', (err, ctx) => {
  ctx.response.status = err.code || 500;
  ctx.body = await numjucks.render(/**...*/);
})
```
- éƒ¨åˆ†é”™è¯¯ç›´æ¥è¿”å›(apiè¿”å›é”™è¯¯)ï¼šstatus + body
```js
ctx.body = err.message;
```
- é”™è¯¯çš„å¤„ç†è¿˜æœ‰ä¸€ä¸ªä¸¤ç§æ–¹å¼ï¼š
  - ä½¿ç”¨ctx.throw(err) + app.on('error', (err, ctx) => {}) æ¥æ¥ä½œä¸ºå¯ä»¥é¢„æµ‹çš„æ‹¦æˆª
  - é€šè¿‡åœ¨ä¸­é—´ä»¶çš„æœ€å¤–å±‚æ³¨å†Œerror-handleä¸­é—´ä»¶æ¥æ‹¦æˆªæ²¡æœ‰è€ƒè™‘åˆ°çš„æˆ–è€…éç”¨ctx.throwæŠ›å‡ºæ¥çš„é”™è¯¯ï¼š
  ```js
  // error Middleware creator
  const errorHandlerCreator = () => {
    return async (ctx, next) => {
      try {
        await next();
      } catch(err) {
        // å“åº”clientç«¯
        ctx.status = err.status || 500;
        ctx.body = await nunjucks.render('errPage');
        // å°†é”™è¯¯ä¼ é€’ç»™å…¶ä»–ç›‘å¬koaApp.on('error')çš„ä¸­é—´ä»¶å»å¤„ç†,ä¾‹å¦‚è®°å½•ä¸ŠæŠ¥æ—¥å¿—
        ctx.app.emit('error', err, ctx);
      }
    }
  }

  // é”™è¯¯ä¸­é—´ä»¶æ³¨å†Œåœ¨æœ€å‰é¢
  koaApp.use(errorHandlerCreator());

  koaApp.on('error', (err, ctx) => {
    // handler err: å¥½æ¯”è®°å½•ä¸ŠæŠ¥æ—¥å¿—
  })
  ```
- å½“ä¸€ä¸ªä¸­é—´ä»¶å‡½æ•°æŠ›å‡ºé”™è¯¯æ—¶ï¼ŒKoaä¼šæ•è·è¿™ä¸ªé”™è¯¯å¹¶ä¼ é€’ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶å‡½æ•°ã€‚å¦‚æœä¸‹ä¸€ä¸ªä¸­é—´ä»¶å‡½æ•°æ²¡æœ‰å¤„ç†é”™è¯¯ï¼ŒKoaä¼šå°†é”™è¯¯ä¼ é€’ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶å‡½æ•°ï¼Œä¾æ­¤ç±»æ¨ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªå¤„ç†é”™è¯¯çš„ä¸­é—´ä»¶å‡½æ•°æˆ–è€…è¾¾åˆ°åº”ç”¨ç¨‹åºçš„æœ«å°¾ã€‚
ctx.app.emit('error', err, ctx) è¿™è¡Œä»£ç çš„ä½œç”¨æ˜¯æ‰‹åŠ¨è§¦å‘ä¸€ä¸ªåä¸º"error"çš„äº‹ä»¶ï¼Œå¹¶å°†é”™è¯¯å¯¹è±¡å’Œä¸Šä¸‹æ–‡å¯¹è±¡ä½œä¸ºå‚æ•°ä¼ é€’ç»™äº‹ä»¶å¤„ç†å‡½æ•°ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†æä¾›ä¸€ç§è‡ªå®šä¹‰é”™è¯¯å¤„ç†æœºåˆ¶çš„æœºä¼šã€‚é€šè¿‡ç›‘å¬"error"äº‹ä»¶ï¼Œå¯ä»¥ç¼–å†™è‡ªå·±çš„é”™è¯¯å¤„ç†é€»è¾‘ï¼Œä¾‹å¦‚è®°å½•é”™è¯¯æ—¥å¿—ã€å‘é€é”™è¯¯æŠ¥å‘Šæˆ–è€…è¿”å›å‹å¥½çš„é”™è¯¯é¡µé¢ç­‰ã€‚
- ä¸€èˆ¬è€Œè¨€ï¼Œctx.app.emit('error', err, ctx) ç”¨äºå¤„ç†ä»¥ä¸‹åœºæ™¯ï¼š
  - ä¸­é—´ä»¶å‡½æ•°å‘ç”Ÿé”™è¯¯ï¼šå½“ä¸€ä¸ªä¸­é—´ä»¶å‡½æ•°åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œå¯ä»¥é€šè¿‡æŠ›å‡ºå¼‚å¸¸æˆ–è€…è¿”å›ä¸€ä¸ªé”™è¯¯çŠ¶æ€ç æ¥æ ‡è®°é”™è¯¯ã€‚æ­¤æ—¶ï¼ŒKoaä¼šå°†é”™è¯¯ä¼ é€’ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶å‡½æ•°ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªå¤„ç†é”™è¯¯çš„ä¸­é—´ä»¶å‡½æ•°æˆ–è€…è¾¾åˆ°åº”ç”¨ç¨‹åºçš„æœ«å°¾ã€‚
  - è‡ªå®šä¹‰é”™è¯¯å¤„ç†ï¼šå¦‚æœéœ€è¦åœ¨åº”ç”¨ç¨‹åºä¸­å®ç°è‡ªå®šä¹‰çš„é”™è¯¯å¤„ç†é€»è¾‘ï¼Œå¯ä»¥ä½¿ç”¨ ctx.app.emit('error', err, ctx)
# logger
- koa-log
# ä¼˜åŒ–éƒ¨ç½²ä¸äº‘
## æ€§èƒ½æŒ‡æ ‡
## æ€§èƒ½æŒ‡æ ‡ä¼˜åŒ–
# å•å…ƒæµ‹è¯•
# ç™»å½•
- å°ç¨‹åºçš„ç™»å½•ï¼š
  - å°ç¨‹åºå‘å¾®ä¿¡nativeè·å–code+appid -> å‘èµ·è¯·æ±‚ï¼šå¼€å‘è€…æœåŠ¡å™¨ -> è¯·æ±‚å¾®ä¿¡æ¥å£æœåŠ¡ï¼šè·å¾—openidç­‰è´¦æˆ·ä¿¡æ¯
  -> å°†openidå­˜åœ¨DB: Userè¡¨ä¸­ï¼Œå’Œç”¨æˆ·å…³è”èµ·æ¥ -> ç”Ÿæˆä¸€ä¸ªè‡ªå®šä¹‰ç™»å½•å‡­è¯ï¼šJWT ï¼ˆé‡Œé¢payloadä¸­æœ‰db.User.id+timeStamp:ç”¨æ¥æ ¡éªŒæ˜¯ä¸æ˜¯è¶…æ—¶ï¼‰
  -> å°†JWTå‘ç»™å°ç¨‹åºï¼Œå°ç¨‹åºå­˜åœ¨cookieæˆ–è€…å…¶ä»–storageä¸­
# é‰´æƒ
## cookie
åœ¨Koa.jsæ¡†æ¶ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ä¸­é—´ä»¶**koa-cookie-parser**æ¥è§£æå’Œè®¾ç½®cookieã€‚ä»¥ä¸‹æ˜¯ä½¿ç”¨koa-cookie-parserä¸­é—´ä»¶è®¾ç½®å’Œè·å–cookieçš„ç¤ºä¾‹ï¼š

- å®‰è£…koa-cookie-parserä¸­é—´ä»¶ï¼š

```shell
npm install koa-cookie-parser --save
```
åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨koa-cookie-parserä¸­é—´ä»¶ï¼š

```javascript
const Koa = require('koa');  
const cookieParser = require('koa-cookie-parser');  
  
const app = new Koa();  
app.use(cookieParser());
```
- è®¾ç½®cookieï¼š
åœ¨è®¾ç½®cookieæ—¶ï¼Œä½¿ç”¨ctx.cookies.set()æ–¹æ³•ã€‚è¯¥æ–¹æ³•æ¥å—ä¸‰ä¸ªå‚æ•°ï¼šcookieåç§°ï¼Œcookieå€¼å’Œé€‰é¡¹å¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹ä»£ç å°†è®¾ç½®ä¸€ä¸ªåä¸ºsession_idçš„cookieï¼Œå…¶å€¼ä¸ºéšæœºç”Ÿæˆçš„å­—ç¬¦ä¸²ï¼š
```javascript
app.use((ctx, next) => {  
  const sessionId = Math.random().toString(36).substring(7);  
  // ctx.cookies.setåŸç”Ÿçš„æ“ä½œcookieçš„æ–¹æ³•ï¼Œparserä»…ä»…æ˜¯å°†cookieå­—ç¬¦ä¸²è§£æä¸ºå¯¹è±¡ï¼Œåº•å±‚åº”è¯¥å¯ä»¥ä½¿ç”¨ctx.set("Set-Cookie")
  ctx.cookies.set('session_id', sessionId);  
  next();  
});
```
- è·å–cookieï¼š
åœ¨è·å–cookieæ—¶ï¼Œä½¿ç”¨ctx.cookies.get()æ–¹æ³•ã€‚è¯¥æ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°ï¼šcookieåç§°å’Œé€‰é¡¹å¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹ä»£ç å°†è·å–åä¸ºsession_idçš„cookieçš„å€¼ï¼š
```js
app.get('/get-cookie', (ctx) => {
  // åº•å±‚ï¼šctx.get("Cookie")
  const sessionId = ctx.cookies.get('session_id');  
  ctx.body = `Session ID cookie value: ${sessionId}`;  
});
```
åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œctx.cookies.get()æ–¹æ³•å°†è¿”å›åä¸ºsession_idçš„cookieçš„å€¼ã€‚å¦‚æœè¯¥cookieä¸å­˜åœ¨ï¼Œåˆ™è¿”å›undefinedã€‚
## session
- sessioæ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œä¸€ä¸ªæ–¹å¼ï¼Œå¹¶ä¸æ˜¯httpä¸­æœ‰sessionè¿™ä¸ªä¸œè¥¿
- sessionæ—¢å¯ä»¥ä½¿ç”¨å†…å­˜å˜é‡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨redisç­‰è¿›è¡Œå­˜å‚¨
  - ä¾‹å¦‚ koa-redis å’Œ koa-redis-sessionã€‚è¿™äº›åº“æä¾›äº†å°† Redis ä½œä¸ºä¼šè¯å­˜å‚¨åç«¯çš„æ”¯æŒï¼Œå¹¶æä¾›äº†æ›´å¤šçš„ä¼šè¯ç®¡ç†åŠŸèƒ½ï¼Œä¾‹å¦‚æ›´é•¿æ—¶é—´çš„ä¼šè¯æŒä¹…æ€§ã€ä¼šè¯å…±äº«ç­‰ã€‚
- seesionä¸€èˆ¬æ­é…cookieæ¥å­˜å‚¨sessionâ€”id
- æ­¥éª¤ï¼š
- å®‰è£…koa-sessionä¸­é—´ä»¶
é¦–å…ˆï¼Œéœ€è¦å®‰è£…koa-sessionä¸­é—´ä»¶ã€‚å¯ä»¥ä½¿ç”¨npmæˆ–yarnæ¥å®‰è£…å®ƒï¼š
```shell
npm install koa-session
```
æˆ–è€…

```shell
yarn add koa-session
```
å¼•å…¥koa-sessionä¸­é—´ä»¶
åœ¨ä½ çš„åº”ç”¨ç¨‹åºæ–‡ä»¶ä¸­ï¼Œå¼•å…¥koa-sessionä¸­é—´ä»¶ï¼š
```javascript
const Koa = require('koa');  
const session = require('koa-session');  
  
const app = new Koa();  
app.keys = ['some secret hurr']; // è®¾ç½®ä¸€ä¸ªå¯†é’¥ç”¨äºç­¾åä¼šè¯IDï¼Œéœ€è¦æ˜¯æ•°ç»„å½¢å¼ï¼Œè‡³å°‘ä¸€ä¸ªã€‚  
app.use(session());
```
è®¾ç½®ä¼šè¯æ•°æ®
åœ¨ä»»ä½•è·¯ç”±æˆ–ä¸­é—´ä»¶ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡ctx.sessionå¯¹è±¡æ¥è®¾ç½®å’Œè·å–ä¼šè¯æ•°æ®ï¼š
```javascript
app.use(async ctx => {  
  ctx.session.username = 'example'; // è®¾ç½®ä¼šè¯æ•°æ®  
  console.log(ctx.session.username); // è·å–ä¼šè¯æ•°æ®  
});
```
ç¦ç”¨ä¼šè¯æ•°æ®è‡ªåŠ¨åºåˆ—åŒ–/ååºåˆ—åŒ–
é»˜è®¤æƒ…å†µä¸‹ï¼Œkoa-sessionä¼šè‡ªåŠ¨åºåˆ—åŒ–/ååºåˆ—åŒ–ä¼šè¯æ•°æ®ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜ã€‚å› æ­¤ï¼Œå»ºè®®ç¦ç”¨è¿™ä¸ªåŠŸèƒ½ï¼š
```javascript
// é€šè¿‡é…ç½®é¡¹keyæ¥æŒ‡å®šä¼šè¯IDåœ¨cookieä¸­çš„é”®å
app.use(session({  
  key: 'myapp_session_id', // å°†é”®åè®¾ç½®ä¸º'myapp_session_id',ä¼šè¯IDå­˜å‚¨åœ¨cookieä¸­çš„é”®åã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œkeyçš„å€¼ä¸ºkoa:sess  
  maxAge: 86400000, // è®¾ç½®ä¼šè¯IDå­˜å‚¨åœ¨cookieä¸­çš„è¿‡æœŸæ—¶é—´ä¸º86400000æ¯«ç§’  
  autoCommit: true, // è‡ªåŠ¨å°†ä¼šè¯æ•°æ®æäº¤åˆ°å“åº”å¤´ä¸­  
  overwrite: true, // æ˜¯å¦å…è®¸é‡å†™ä¼šè¯æ•°æ®  
  signed: true, // æ˜¯å¦ç­¾åä¼šè¯ID  
  rolling: false, // æ˜¯å¦æ¯æ¬¡å“åº”æ—¶åˆ·æ–°ä¼šè¯çš„æœ‰æ•ˆæœŸ  
}));
// ä¼šè¯IDå­˜å‚¨åœ¨cookieä¸­çš„è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ã€‚å¯é€‰ã€‚é»˜è®¤å€¼ï¼šnullï¼ˆå³é»˜è®¤cookieçš„è¿‡æœŸæ—¶é—´ï¼‰ã€‚å¦‚æœéœ€è¦è®¾ç½®ç‰¹å®šçš„è¿‡æœŸæ—¶é—´ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ timeout æˆ–è€… cookie çš„ maxAge é…ç½®é¡¹ã€‚å¦‚æœ maxAge æ˜¯ 'false'ï¼Œåˆ™ cookie å°†ä¸ä¼šè¿‡æœŸã€‚å¦‚æœ maxAge æ˜¯ 'true'ï¼Œåˆ™ç­‰åŒäºé»˜è®¤å€¼ 'null'ã€‚å¦‚æœ maxAge æ˜¯å…¶ä»–å€¼ï¼Œé‚£ä¹ˆå®ƒå°†è¢«ç”¨ä½œ cookie çš„ maxAge å€¼ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚ä¾‹å¦‚ï¼šè®¾ç½®1å°æ—¶åè¿‡æœŸï¼Œå¯ä»¥è®¾ç½®maxAgeä¸º3600000ã€‚ é»˜è®¤å€¼ï¼šnullã€‚å¯é€‰ã€‚ é»˜è®¤å€¼ï¼šnullã€‚å¯é€‰ã€‚ é»˜è®¤å€¼ï¼šnullã€‚å¯é€‰ã€‚ é»˜è®¤å€¼ï¼šnullã€‚å¯é€‰ã€‚ é»˜è®¤å€¼ï¼šnullã€‚å¯é€‰ã€‚ é»˜è®¤å€¼ï¼šnullã€‚å¯é€‰ã€‚ é»˜è®¤å€¼ï¼šnullã€‚å¯é€‰ã€‚ é»˜è®¤å€¼ï¼šnullã€‚å¯é€‰ã€‚ é»˜è®¤å€¼ï¼šnullã€‚å¯é€‰ã€‚ é»˜è®¤å€¼ï¼šnullã€‚å¯é€‰ã€‚ é»˜è®¤å€¼ï¼šnullã€‚å¯é€‰ã€‚ é»˜è®¤å€¼ï¼šnullã€‚å¯é€‰ã€‚ é»˜è®¤å€¼ï¼šnullã€‚å¯é€‰ã€‚ é»˜è®¤å€¼ï¼šnullã€‚å¯é€‰ã€‚ é»˜è®¤å€¼ï¼šnullã€‚å¯é€‰ã€‚ é»˜è®¤å€¼ï¼šnullã€‚å¯é€‰ã€‚ é»˜è®¤å€¼ï¼šnullã€‚å¯é€‰ã€‚ é»˜è®¤å€¼ï¼šnullã€‚å¯é€‰ã€‚ é»˜è®¤å€¼ï¼šnullã€‚å¯é€‰ã€‚ é»˜è®¤å€¼ï¼šnullã€‚å¯é€‰ã€‚ é»˜è®¤å€¼ï¼šnullã€‚å¯é€‰ã€‚ é»˜è®¤å€¼ï¼šnullã€‚å¯é€‰ã€‚ é»˜è®¤å€¼ï¼šnullã€‚å¯é€‰ã€‚ é»˜è®¤å€¼ï¼šnullã€‚å¯é€‰ã€‚ é»˜è®¤å€¼ï¼šnullã€‚å¯é€‰ã€‚ é»˜è®¤å€¼ï¼šnullã€‚å¯é€‰ã€‚ é»˜è®¤å€¼ï¼šnullï¼ˆæ— è¿‡æœŸæ—¶é—´ï¼‰ã€‚å¯é€‰ï¼ˆé»˜è®¤ä¸º falseï¼‰ã€‚
```
é€šè¿‡è®¾ç½®keyçš„å€¼ï¼Œå¯ä»¥è‡ªå®šä¹‰ä¼šè¯IDåœ¨cookieä¸­çš„é”®åï¼Œä»¥ä¾¿æ›´å¥½åœ°é€‚åº”åº”ç”¨ç¨‹åºçš„éœ€æ±‚ã€‚
## JWT
åœ¨Koa.jsä¸­ä½¿ç”¨JWTï¼ˆJSON Web Tokensï¼‰è¿›è¡Œèº«ä»½éªŒè¯å’Œæˆæƒæ˜¯ä¸€ä¸ªå¸¸è§çš„åšæ³•ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•åœ¨Koa.jsåº”ç”¨ç¨‹åºä¸­ä½¿ç”¨JWTã€‚
é¦–å…ˆï¼Œç¡®ä¿å·²ç»å®‰è£…äº†koa-jwt2åº“ã€‚ä½ å¯ä»¥ä½¿ç”¨npmæˆ–yarnæ¥å®‰è£…å®ƒï¼š
```shell
npm install koa-jwt2
```
æˆ–è€…
```shell
yarn add koa-jwt2
```
æ¥ä¸‹æ¥ï¼Œåœ¨ä½ çš„Koa.jsåº”ç”¨ç¨‹åºä¸­å¼•å…¥koa-jwt2ä¸­é—´ä»¶ï¼Œå¹¶é…ç½®å®ƒä»¥ä½¿ç”¨ä½ çš„JWTå¯†é’¥å’Œä»¤ç‰Œã€‚
```javascript
const Koa = require('koa');  
const jwt = require('koa-jwt2');  
  
const app = new Koa();  
  
// é…ç½®JWTå¯†é’¥å’Œä»¤ç‰Œ  
const secretKey = 'your-secret-key'; // æ›¿æ¢ä¸ºä½ çš„å¯†é’¥  
const token = 'your-token'; // æ›¿æ¢ä¸ºä½ çš„ä»¤ç‰Œï¼Œä»¤ç‰Œå°±æ˜¯jwt: head.body.signatureçš„å­—ç¬¦ä¸²
// æœ¬è´¨ä¸Š koa-jwtåšçš„äº‹æƒ…å°±æ˜¯æŒ‰ç…§jwtçš„è§„åˆ™è®¾è®¡ï¼šå°†è¯·æ±‚ä¸­æºå¸¦çš„tokenä¸­çš„body + serverç«¯ä¿å­˜çš„secretæŒ‰ç…§headä¸­çš„ç®—æ³•è®¡ç®—å¾—å‡ºsignature2 å’Œæºå¸¦çš„signatureæ¯”å¯¹ï¼Œçœ‹æ˜¯å¦ä¸€è‡´ï¼Œä¸€è‡´åˆ™æ˜¯åˆæ³•ç”¨æˆ·
  
// ä½¿ç”¨JWTä¸­é—´ä»¶  
app.use(jwt({ secretKey, token }));
```
ç°åœ¨ï¼Œä½ å¯ä»¥åœ¨è·¯ç”±ä¸­ä½¿ç”¨JWTè¿›è¡Œèº«ä»½éªŒè¯å’Œæˆæƒã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹è·¯ç”±ï¼Œå®ƒä½¿ç”¨JWTéªŒè¯ç”¨æˆ·çš„èº«ä»½ï¼š

```javascript
app.use(async (ctx, next) => {  
  // è·å–å­˜å‚¨åœ¨è¯·æ±‚ä¸­çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰  
  const user = ctx.state.user;  
  if (!user) {  
    // å¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ™æ£€æŸ¥è¯·æ±‚ä¸­æ˜¯å¦åŒ…å«ä»¤ç‰Œï¼ˆtokenï¼‰  
    const token = ctx.request.headers['authorization']; // ä»è¯·æ±‚å¤´ä¸­è·å–ä»¤ç‰Œï¼ˆå¯é€‰ï¼‰  
    if (token) {  
      // é‰´æƒ
      try {  
        // è§£ç ä»¤ç‰Œå¹¶éªŒè¯å…¶æœ‰æ•ˆæ€§  
        const decoded = jwt.verify(token, secretKey); // ä½¿ç”¨JWTå¯†é’¥è§£ç ä»¤ç‰Œï¼ˆå¯é€‰ï¼‰  
        if (decoded) {  
          // å¦‚æœä»¤ç‰Œæœ‰æ•ˆï¼Œåˆ™å°†ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åœ¨è¯·æ±‚ä¸Šä¸‹æ–‡ä¸­ï¼ˆctx.state.userï¼‰  
          ctx.state.user = decoded; // å°†ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åœ¨ctx.state.userä¸­ï¼ˆå¯é€‰ï¼‰  
        } else {  
          // å¦‚æœä»¤ç‰Œæ— æ•ˆï¼Œè¿”å›é”™è¯¯å“åº”æˆ–è¿›è¡Œå…¶ä»–å¤„ç†ï¼ˆå¯é€‰ï¼‰  
          ctx.status = 401; // è¿”å›401æœªæˆæƒçŠ¶æ€ç ï¼ˆå¯é€‰ï¼‰  
          return; // åœæ­¢è¿›ä¸€æ­¥å¤„ç†è¯¥è¯·æ±‚ï¼ˆå¯é€‰ï¼‰  
        }  
      } catch (error) {  
        // å¤„ç†è§£ç ä»¤ç‰Œæ—¶å‘ç”Ÿçš„é”™è¯¯ï¼ˆå¯é€‰ï¼‰  
        console.error('Error decoding JWT:', error); // æ‰“å°é”™è¯¯æ—¥å¿—ï¼ˆå¯é€‰ï¼‰  
      }  
    } else {  
      // å¦‚æœè¯·æ±‚ä¸­æ²¡æœ‰ä»¤ç‰Œï¼Œè¿”å›é”™è¯¯å“åº”æˆ–è¿›è¡Œå…¶ä»–å¤„ç†ï¼ˆå¯é€‰ï¼‰  
      ctx.status = 401; // è¿”å›401æœªæˆæƒçŠ¶æ€ç ï¼ˆå¯é€‰ï¼‰  
      return; // åœæ­¢è¿›ä¸€æ­¥å¤„ç†è¯¥è¯·æ±‚ï¼ˆå¯é€‰ï¼‰  
    }  
  } else {  
    // å¦‚æœç”¨æˆ·å·²ç»å­˜åœ¨äºè¯·æ±‚ä¸Šä¸‹æ–‡ä¸­ï¼ˆctx.state.userï¼‰ï¼Œåˆ™ç»§ç»­å¤„ç†è¯·æ±‚ï¼ˆå¯é€‰ï¼‰  
  }  
  await next(); // ç»§ç»­å¤„ç†åç»­ä¸­é—´ä»¶å’Œè·¯ç”±å¤„ç†å‡½æ•°ï¼ˆå¯é€‰ï¼‰  
});
```
- eg2:
```js 
// é‰´æƒä¸­é—´ä»¶  
const anthMiddleware = async (ctx, next) => {  
  const token = ctx.request.headers.authorization; // ä»è¯·æ±‚å¤´ä¸­è·å–token  
  
  if (!token) {  
    ctx.throw(401, 'Unauthorized'); // æ²¡æœ‰tokenåˆ™è¿”å›401é”™è¯¯  
  } else {  
    const user = await authenticate(token); // è°ƒç”¨é‰´æƒå‡½æ•°éªŒè¯token  
    if (!user) {  
      ctx.throw(403, 'Forbidden'); // é‰´æƒå¤±è´¥åˆ™è¿”å›403é”™è¯¯  
    } else {  
      ctx.state.user = user; // å°†é‰´æƒæˆåŠŸçš„ç”¨æˆ·ä¿¡æ¯æ”¾å…¥ctx.stateä¸­  
      await next(); // ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶æˆ–è·¯ç”±å¤„ç†å‡½æ•°  
    }  
  }  
};
```

# åŒå·¥é€šä¿¡
## websocket
## socket.io
## SSE
## é•¿è½®è¯¢
## çŸ­è½®è¯¢

# ä¸“é¡¹
## koa-static
è¦å®ç°ä¸€ä¸ªç®€å•çš„Koa-staticä¸­é—´ä»¶ï¼Œä½ éœ€è¦ä½¿ç”¨Node.jså’ŒKoaæ¡†æ¶ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªåŸºæœ¬çš„Koa-staticä¸­é—´ä»¶å®ç°ï¼ŒåŒ…æ‹¬é”™è¯¯å¤„ç†ã€MIMEç±»å‹åŒ¹é…å’Œè®¾ç½®å¤§æ–‡ä»¶å“åº”çš„åŠŸèƒ½ã€‚

```javascript
// è®¾ç½®é™æ€èµ„æºç›®å½•å’Œæœ€å¤§æ–‡ä»¶å¤§å°  
const staticDir = path.join(__dirname, 'public');  
const maxFileSize = 1024 * 1024 * 10; // 10 MB  
  
// å®šä¹‰ä¸­é—´ä»¶å‡½æ•°  
async function koaStatic(dir) {  
  return async (ctx, next) => {  
    const file = ctx.request.path;  
    const filePath = path.join(dir, file);  
  
    // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨  
    try {  
      const stats = fs.statSync(filePath);  
      if (!stats.isFile()) {  
        ctx.throw(404, 'File not found');  
        return;  
      }  
    } catch (err) {  
      ctx.throw(500, 'Internal server error');  
      return;  
    }  
  
    // æ£€æŸ¥æ–‡ä»¶å¤§å°æ˜¯å¦è¶…è¿‡é™åˆ¶  
    try {  
      const fileSize = fs.statSync(filePath).size;  
      if (fileSize > maxFileSize) {  
        ctx.throw(413, 'Request entity too large');  
        return;  
      }  
    } catch (err) {  
      ctx.throw(500, 'Internal server error');  
      return;  
    }  
  
    // è¯»å–æ–‡ä»¶å†…å®¹å¹¶è®¾ç½®å“åº”å¤´ä¿¡æ¯  
    const fileStream = fs.createReadStream(filePath);  
    ctx.set('Content-Type', getMimeType(file));  
    ctx.body = fileStream;  
  };  
}  
  
// è·å–MIMEç±»å‹çš„æ–¹æ³•ï¼ˆæ ¹æ®æ–‡ä»¶æ‰©å±•åï¼‰  
function getMimeType(file) {  
  const extname = path.extname(file).toLowerCase();  
  const mimeTypes = {  
    '.html': 'text/html',  
    '.js': 'text/javascript',  
    '.css': 'text/css',  
    '.png': 'image/png',  
    '.jpg': 'image/jpg',  
    '.gif': 'image/gif',  
  };  
  return mimeTypes[extname] || 'application/octet-stream';  
}  
  
// é”™è¯¯å¤„ç†ä¸­é—´ä»¶å‡½æ•°  
async function errorHandler(ctx, next) {  
  try {  
    await next();  
  } catch (err) {  
    ctx.status = err.status || 500;  
    ctx.body = `<h1>${err.message}</h1><p>Internal server error</p>`;  
    ctx.app.emit('error', err, ctx); // å°†é”™è¯¯äº‹ä»¶ä¼ é€’ç»™å…¶ä»–ä¸­é—´ä»¶å¤„ç†ï¼ˆä¾‹å¦‚æ—¥å¿—è®°å½•ï¼‰  
  }  
}  
  
// é…ç½®Koaåº”ç”¨ç¨‹åºä¸­é—´ä»¶é¡ºåºå’Œè·¯ç”±è§„åˆ™ï¼ˆå¦‚æœéœ€è¦ï¼‰  
app.use(errorHandler); // å°†é”™è¯¯å¤„ç†ä¸­é—´ä»¶æ”¾åœ¨æœ€å‰é¢ï¼Œä»¥ä¾¿æ•è·æ‰€æœ‰é”™è¯¯å¹¶ç»Ÿä¸€å¤„ç†ã€‚å…¶ä»–ä¸­é—´ä»¶å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ ã€‚
```

## æ–‡ä»¶ä¸Šä¼ 
åœ¨Koaä¸­ï¼ŒMulteræ˜¯ä¸€ä¸ªä¸­é—´ä»¶ï¼Œç”¨äºå¤„ç†Multipart/form-dataç±»å‹çš„è¡¨å•æ•°æ®ï¼Œå®ƒä¸»è¦ç”¨äºä¸Šä¼ æ–‡ä»¶ã€‚

Multeråœ¨å†…éƒ¨ä½¿ç”¨formidableæ¨¡å—æ¥è§£æmultipart/form-dataç±»å‹çš„æ•°æ®ã€‚å½“è¯·æ±‚åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶æ—¶ï¼ŒMulterä¼šæ¥ç®¡è¿™äº›æ–‡ä»¶å¹¶å°†å…¶ä¿å­˜åœ¨ä¸´æ—¶ç›®å½•ä¸­ï¼ŒåŒæ—¶å°†æ–‡ä»¶ä¿¡æ¯å­˜å‚¨åœ¨ctx.request.fileså¯¹è±¡ä¸­ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„Multerå®ç°ç¤ºä¾‹ï¼š

```javascript
const Router = require('@koa/router');  
const bodyParser = require('koa-bodyparser');  
  
const app = new Koa();  
const router = new Router();  
  
// åˆ›å»ºMulterä¸­é—´ä»¶å¹¶è®¾ç½®ä¿å­˜ä¸Šä¼ æ–‡ä»¶çš„ç›®å½•  
const multer = async (ctx, next) => {  
  const file = ctx.request.files.file; // è·å–ä¸Šä¼ çš„æ–‡ä»¶  
  const filePath = path.join(__dirname, 'uploads', file.name); // æ‹¼æ¥ä¿å­˜æ–‡ä»¶çš„è·¯å¾„  
  // ğŸ”¥åœ¨Koaä¸­ï¼Œctx.request.files.file.pathæœ¬è´¨ä¸Šæ˜¯ä¸´æ—¶æ–‡ä»¶çš„è·¯å¾„ã€‚å½“å®¢æˆ·ç«¯ä¸Šä¼ æ–‡ä»¶æ—¶ï¼ŒKoaä¸­é—´ä»¶ä¼šæ¥æ”¶è¿™äº›æ–‡ä»¶ï¼Œå¹¶å°†å…¶ä¿å­˜åœ¨ä¸´æ—¶ç›®å½•ä¸­ã€‚ctx.request.files.file.pathå°±æ˜¯æŒ‡å‘è¿™ä¸ªä¸´æ—¶æ–‡ä»¶çš„è·¯å¾„ã€‚åœ¨å¤„ç†å®Œæ–‡ä»¶ä¹‹åï¼Œé€šå¸¸éœ€è¦å°†æ–‡ä»¶ä»ä¸´æ—¶ç›®å½•ç§»åŠ¨åˆ°å…¶ä»–ä½ç½®è¿›è¡Œå­˜å‚¨ã€‚
  fs.createReadStream(file.path).pipe(fs.createWriteStream(filePath)); // å°†æ–‡ä»¶ä¿å­˜åˆ°æŒ‡å®šç›®å½•  
  ctx.body = 'File uploaded successfully.'; // è¿”å›ä¸Šä¼ æˆåŠŸçš„ä¿¡æ¯  
};  
app.use(multer);  
  
// åˆ›å»ºè·¯ç”±ä»¥å¤„ç†æ–‡ä»¶ä¸Šä¼ è¯·æ±‚  
router.post('/upload', (ctx) => {  
  ctx.request.files = { file: [] }; // è®¾ç½®ctx.request.fileså¯¹è±¡ä»¥æ¥æ”¶ä¸Šä¼ çš„æ–‡ä»¶  
  ctx.body = 'Please upload a file.'; // è¿”å›æç¤ºä¿¡æ¯  
});  
  
app.use(router.routes());  
app.listen(3000, () => { console.log('Server started on port 3000'); });
// åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªç®€å•çš„Multerä¸­é—´ä»¶ã€‚å½“æ”¶åˆ°åŒ…å«æ–‡ä»¶çš„POSTè¯·æ±‚æ—¶ï¼ŒMulterä¼šä¿å­˜æ–‡ä»¶åˆ°æŒ‡å®šçš„ç›®å½•ï¼Œå¹¶å°†æ–‡ä»¶ä¿¡æ¯å­˜å‚¨åœ¨ctx.request.fileså¯¹è±¡ä¸­ã€‚ç„¶åï¼Œåº”ç”¨ç¨‹åºä¼šè¿”å›ä¸€ä¸ªæˆåŠŸæ¶ˆæ¯ã€‚è¯·æ³¨æ„ï¼Œè¿™åªæ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå®é™…åº”ç”¨ä¸­å¯èƒ½éœ€è¦æ›´å¤šçš„é”™è¯¯å¤„ç†å’ŒéªŒè¯æ­¥éª¤ã€‚
```

## å¤§æ–‡ä»¶æ–­ç‚¹ç»­ä¼ 
æ–‡ä»¶æ–­ç‚¹ç»­ä¼ æ˜¯ä¸€ç§åœ¨ä¸‹è½½æˆ–ä¸Šä¼ è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå‘ç”Ÿä¸­æ–­ï¼Œèƒ½å¤Ÿç»§ç»­ä¸‹è½½æˆ–ä¸Šä¼ æ–‡ä»¶çš„æŠ€æœ¯ã€‚å®ƒå…è®¸ç”¨æˆ·åœ¨ä¸Šä¼ æˆ–ä¸‹è½½ä¸­æ–­åæ¢å¤æ“ä½œè€Œä¸å¿…é‡æ–°å¼€å§‹ã€‚

å…·ä½“æ¥è¯´ï¼Œåœ¨ä¸‹è½½æ—¶ï¼Œå¦‚æœç½‘ç»œä¸­æ–­å¯¼è‡´ä¸‹è½½æœªèƒ½å®Œæˆï¼Œä½¿ç”¨æ–­ç‚¹ç»­ä¼ æŠ€æœ¯å¯ä»¥å°†ä¸‹è½½ä»»åŠ¡åˆ’åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ï¼Œç„¶åé‡æ–°ä¸Šä¼ å·²ä¸‹è½½çš„éƒ¨åˆ†ï¼Œè€Œä¸éœ€è¦é‡æ–°ä¸‹è½½æ•´ä¸ªæ–‡ä»¶ã€‚åŒæ ·ï¼Œåœ¨ä¸Šä¼ æ—¶ï¼Œå¦‚æœæ–‡ä»¶è¿‡å¤§å¯¼è‡´ä¸Šä¼ æœªèƒ½å®Œæˆï¼Œä½¿ç”¨æ–­ç‚¹ç»­ä¼ æŠ€æœ¯å¯ä»¥å°†æ–‡ä»¶åˆ’åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ï¼Œç„¶ååˆ†åˆ«ä¸Šä¼ ï¼Œå¹¶åœ¨æœ€ååœ¨æœåŠ¡å™¨ç«¯åˆå¹¶æ–‡ä»¶ã€‚è¿™æ ·ï¼Œå³ä½¿ä¸Šä¼ è¿‡ç¨‹ä¸­å‡ºç°ä¸­æ–­ï¼Œä¹Ÿèƒ½å¤Ÿç»§ç»­ä¸Šä¼ è€Œä¸éœ€è¦é‡æ–°å¼€å§‹æ•´ä¸ªä¸Šä¼ è¿‡ç¨‹ã€‚

æ€»ä¹‹ï¼Œæ–‡ä»¶æ–­ç‚¹ç»­ä¼ æ˜¯ä¸€ç§æé«˜æ–‡ä»¶ä¸‹è½½æˆ–ä¸Šä¼ æ•ˆç‡çš„æŠ€æœ¯ï¼Œå®ƒèƒ½å¤ŸèŠ‚çœæ—¶é—´å’Œæµé‡ï¼ŒåŒæ—¶ä¹Ÿæé«˜äº†ç”¨æˆ·ä½“éªŒã€‚

### æ–‡ä»¶æ–­ç‚¹ç»­ä¼ ï¼šä¸‹è½½
æ–‡ä»¶æ–­ç‚¹ç»­ä¼ åœ¨ä¸‹è½½æ—¶çš„å·¥ä½œåŸç†å¦‚ä¸‹ï¼š

1. å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€æ”¯æŒæ–­ç‚¹ç»­ä¼ çš„è¯·æ±‚ï¼Œè¯·æ±‚ä¸­åŒ…å«è¦ä¸‹è½½çš„æ–‡ä»¶åæˆ–å…¶ä»–æ ‡è¯†ç¬¦ã€‚
2. æœåŠ¡å™¨å“åº”è¯·æ±‚ï¼Œå¹¶è¿”å›ä¸€ä¸ªå·²ç»ä¸Šä¼ çš„ä½ç½®æ ‡è®°ï¼ˆpositionï¼‰ç»™å®¢æˆ·ç«¯ã€‚è¿™ä¸ªä½ç½®æ ‡è®°å‘Šè¯‰å®¢æˆ·ç«¯ä»å“ªä¸ªå­—èŠ‚å¼€å§‹æ¥æ”¶æ–‡ä»¶ã€‚
3. å®¢æˆ·ç«¯å°†æ¥æ”¶åˆ°çš„æ–‡ä»¶éƒ¨åˆ†ä¸ä¹‹å‰å·²ç»ä¸‹è½½çš„éƒ¨åˆ†è¿›è¡Œåˆå¹¶ï¼Œç›´åˆ°æ•´ä¸ªæ–‡ä»¶è¢«ä¸‹è½½å®Œæˆã€‚

åœ¨æ–­ç‚¹ç»­ä¼ ä¸­ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´éœ€è¦å»ºç«‹ä¸€ç§åè®®æ¥æ”¯æŒæ–­ç‚¹ç»­ä¼ ã€‚ä¾‹å¦‚ï¼ŒHTTPåè®®ä¸­çš„Rangeè¯·æ±‚å¤´å’ŒAccept-Rangeå“åº”å¤´å°±æ˜¯ä¸€ç§å¸¸ç”¨çš„åè®®ã€‚å®¢æˆ·ç«¯ä½¿ç”¨Rangeè¯·æ±‚å¤´å‘Šè¯‰æœåŠ¡å™¨è¦ä¸‹è½½çš„æ–‡ä»¶çš„å­—èŠ‚èŒƒå›´ï¼Œè€ŒæœåŠ¡å™¨åˆ™ä½¿ç”¨Accept-Rangeå“åº”å¤´å‘Šè¯‰å®¢æˆ·ç«¯å¯ä»¥æ¥å—çš„å­—èŠ‚èŒƒå›´ã€‚è¿™æ ·ï¼Œå¦‚æœä¸‹è½½è¿‡ç¨‹ä¸­å‡ºç°ä¸­æ–­ï¼Œå®¢æˆ·ç«¯å¯ä»¥é‡æ–°å‘é€è¯·æ±‚å¹¶ä»ä¹‹å‰å·²ç»ä¸‹è½½çš„éƒ¨åˆ†å¼€å§‹æ¥æ”¶æ–°çš„æ•°æ®ï¼Œä»è€Œå®ç°æ–­ç‚¹ç»­ä¼ ã€‚

æ­¤å¤–ï¼Œä¸€äº›ä¸‹è½½å·¥å…·è¿˜ä¼šé‡‡ç”¨å¤šçº¿ç¨‹ä¸‹è½½æŠ€æœ¯æ¥æé«˜ä¸‹è½½é€Ÿåº¦ã€‚è¿™äº›å·¥å…·ä¼šå°†æ–‡ä»¶åˆ’åˆ†ä¸ºå¤šä¸ªéƒ¨åˆ†ï¼Œå¹¶ä½¿ç”¨ä¸åŒçš„çº¿ç¨‹åŒæ—¶ä¸‹è½½ä¸åŒçš„éƒ¨åˆ†ã€‚è¿™æ ·å¯ä»¥å……åˆ†åˆ©ç”¨å¸¦å®½å’Œè®¡ç®—æœºèµ„æºï¼Œä»è€Œæ›´å¿«åœ°å®Œæˆæ–‡ä»¶ä¸‹è½½ã€‚

æ€»ä¹‹ï¼Œæ–‡ä»¶æ–­ç‚¹ç»­ä¼ åœ¨ä¸‹è½½æ—¶é€šè¿‡åè®®å’ŒæŠ€æœ¯çš„æ”¯æŒï¼Œå®ç°äº†åœ¨ä¸‹è½½ä¸­æ–­åèƒ½å¤Ÿç»§ç»­ä¸‹è½½è€Œä¸éœ€è¦é‡æ–°å¼€å§‹æ•´ä¸ªä¸‹è½½è¿‡ç¨‹çš„åŠŸèƒ½ã€‚

- Koaä¸­çš„æ–­ç‚¹ç»­ä¼ -ä¸‹è½½çš„å¤„ç†æ–¹æ¡ˆï¼škoa-send
åœ¨Koaä¸­å®ç°æ–‡ä»¶æ–­ç‚¹ç»­ä¼ å¯ä»¥ä½¿ç”¨`koa-send`ä¸­é—´ä»¶ã€‚`koa-send`ä¸­é—´ä»¶å¯ä»¥å¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå¹¶å‘é€æ–‡ä»¶åˆ°å®¢æˆ·ç«¯ã€‚å®ƒæ”¯æŒæ–­ç‚¹ç»­ä¼ å’Œæµè§ˆå™¨ç«¯ä¸‹è½½åŠŸèƒ½ï¼Œå¯ä»¥æ ¹æ®å®¢æˆ·ç«¯çš„è¯·æ±‚ä¿¡æ¯ï¼Œåˆ¤æ–­æ˜¯å¦æ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼Œå¹¶è¿”å›ç›¸åº”çš„æ–‡ä»¶å†…å®¹ã€‚

ä½¿ç”¨`koa-send`ä¸­é—´ä»¶å®ç°æ–‡ä»¶æ–­ç‚¹ç»­ä¼ çš„æ­¥éª¤å¦‚ä¸‹ï¼š

1. å®‰è£…`koa-send`ä¸­é—´ä»¶ï¼šä½¿ç”¨npmæˆ–yarnå®‰è£…`koa-send`ä¸­é—´ä»¶ã€‚


```shell
npm install koa-send
```
2. åœ¨Koaåº”ç”¨ä¸­å¼•å…¥`koa-send`ä¸­é—´ä»¶ï¼šåœ¨Koaåº”ç”¨çš„æ–‡ä»¶ä¸­å¼•å…¥`koa-send`ä¸­é—´ä»¶ã€‚


```javascript
const send = require('koa-send');
```
3. åœ¨Koaåº”ç”¨ä¸­ä½¿ç”¨`koa-send`ä¸­é—´ä»¶ï¼šåœ¨Koaåº”ç”¨çš„ä¸­é—´ä»¶ä¸­è°ƒç”¨`send`å‡½æ•°ï¼Œå¹¶ä¼ å…¥è¦å‘é€çš„æ–‡ä»¶è·¯å¾„å’Œé€‰é¡¹ä½œä¸ºå‚æ•°ã€‚é€‰é¡¹å¯ä»¥åŒ…æ‹¬`root`ï¼ˆæŒ‡å®šæ–‡ä»¶æ ¹ç›®å½•ï¼‰ã€`maxage`ï¼ˆæŒ‡å®šç¼“å­˜æ—¶é—´ï¼‰ç­‰ã€‚


```javascript
app.use(async (ctx, next) => {
  await next();
  if (ctx.path === '/file') {
    ctx.body = await send(ctx.req, ctx.path, { root: '/path/to/files', maxage: 86400 });
  }
});
```
åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œå½“å®¢æˆ·ç«¯è¯·æ±‚è·¯å¾„ä¸º`/file`çš„èµ„æºæ—¶ï¼ŒKoaåº”ç”¨ä¼šä½¿ç”¨`koa-send`ä¸­é—´ä»¶å‘é€æ–‡ä»¶åˆ°å®¢æˆ·ç«¯ã€‚`root`é€‰é¡¹æŒ‡å®šäº†æ–‡ä»¶æ ¹ç›®å½•ï¼Œè€Œ`maxage`é€‰é¡¹æŒ‡å®šäº†ç¼“å­˜æ—¶é—´ã€‚

é€šè¿‡ä½¿ç”¨`koa-send`ä¸­é—´ä»¶ï¼ŒKoaåº”ç”¨å¯ä»¥å®ç°æ–‡ä»¶æ–­ç‚¹ç»­ä¼ å’Œæµè§ˆå™¨ç«¯ä¸‹è½½åŠŸèƒ½ï¼Œæé«˜æ–‡ä»¶ä¸Šä¼ å’Œä¸‹è½½çš„æ•ˆç‡å’Œç¨³å®šæ€§ã€‚

- åœ¨æµè§ˆå™¨ä¸­è®¾ç½®æ–­ç‚¹ç»­ä¼ é€šå¸¸éœ€è¦æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„ååŒå¤„ç†ã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š

1. åœ¨æœåŠ¡å™¨ç«¯ï¼Œéœ€è¦æ”¯æŒæ–­ç‚¹ç»­ä¼ åŠŸèƒ½ã€‚åç«¯æœåŠ¡å™¨éœ€è¦é…ç½®æ–­ç‚¹ç»­ä¼ æ”¯æŒï¼Œå½“æ¥æ”¶åˆ°ä¸‹è½½è¯·æ±‚æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦åŒ…å« Range è¯·æ±‚å¤´ã€‚å¦‚æœåŒ…å« Range è¯·æ±‚å¤´ï¼Œåˆ™è§£æå‡ºè¯·æ±‚ä¸­æŒ‡å®šçš„æ–‡ä»¶èŒƒå›´ï¼Œå¹¶è¿”å›å¯¹åº”èŒƒå›´å†…çš„æ–‡ä»¶æ•°æ®å’Œæ­£ç¡®çš„ Content-Range å“åº”å¤´ã€‚å¦‚æœä¸åŒ…å« Range è¯·æ±‚å¤´ï¼Œåˆ™æ­£å¸¸è¿”å›æ•´ä¸ªæ–‡ä»¶å†…å®¹ã€‚
2. åœ¨å®¢æˆ·ç«¯ï¼Œéœ€è¦å®ç°è¯·æ±‚çš„é€»è¾‘ã€‚å½“éœ€è¦ä¸‹è½½å¤§æ–‡ä»¶æ—¶ï¼Œæµè§ˆå™¨ä¼šå…ˆå‘é€ä¸€ä¸ªåªåŒ…å« Range è¯·æ±‚å¤´çš„è¯·æ±‚ï¼Œä»¥ç¡®å®šæœåŠ¡å™¨æ˜¯å¦æ”¯æŒæ–­ç‚¹ç»­ä¼ ã€‚å¦‚æœæœåŠ¡å™¨æ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼Œåˆ™ä»å·²ç»ä¸‹è½½çš„éƒ¨åˆ†å¼€å§‹ç»§ç»­ä¸‹è½½ï¼›å¦‚æœä¸æ”¯æŒï¼Œåˆ™ç›´æ¥ä¿å­˜æ•´ä¸ªæ–‡ä»¶ã€‚

ä»¥ä¸Šä¿¡æ¯ä»…ä¾›å‚è€ƒï¼Œå¯ä»¥æŸ¥é˜…ä¸“ä¸šçš„æŠ€æœ¯æ–‡æ¡£è·å–æ›´å‡†ç¡®æ›´å…¨é¢çš„ä¿¡æ¯ã€‚
- æ–‡ä»¶æ–­ç‚¹ç»­ä¼ æ¶‰åŠåˆ°çš„HTTPå¤´åŒ…æ‹¬è¯·æ±‚å¤´å’Œå“åº”å¤´ã€‚

è¯·æ±‚å¤´ï¼š

1. Rangeï¼šç”¨äºæŒ‡å®šè¯·æ±‚çš„å­—èŠ‚èŒƒå›´ã€‚ä¾‹å¦‚ï¼Œâ€œRange: bytes=0-1â€è¡¨ç¤ºè¯·æ±‚å¼€å¤´çš„2ä¸ªå­—èŠ‚ï¼Œâ€œRange: bytes=-200â€è¡¨ç¤ºè¯·æ±‚æ–‡ä»¶ç»“å°¾å¤„çš„200ä¸ªå­—èŠ‚ã€‚
2. If-Rangeï¼šç”¨äºæ¯”è¾ƒèµ„æºçš„å½“å‰ç‰ˆæœ¬å’Œå®¢æˆ·ç«¯æ‰€æ‹¥æœ‰çš„ç‰ˆæœ¬ï¼Œå¦‚æœä¸¤è€…ç›¸ç­‰ï¼Œåˆ™è¿”å›412ï¼ˆPrecondition Failedï¼‰ï¼Œå¦åˆ™è¿”å›æ‰€è¯·æ±‚çš„å®ä½“ã€‚

å“åº”å¤´ï¼š

1. Accept-Rangesï¼šç”¨äºå‘Šè¯‰å®¢æˆ·ç«¯æœåŠ¡å™¨æ˜¯å¦æ¥å—èŒƒå›´è¯·æ±‚ï¼Œå¦‚æœæ¥å—ï¼Œåˆ™è¿”å›â€œbytesâ€ã€‚
2. Content-Rangeï¼šç”¨äºæè¿°æ‰€è¿”å›å®ä½“çš„èŒƒå›´å’Œæ•´ä¸ªå®ä½“é•¿åº¦ã€‚ä¾‹å¦‚ï¼Œâ€œContent-Range: bytes 0-1/200â€è¡¨ç¤ºè¿”å›äº†å¼€å¤´çš„2ä¸ªå­—èŠ‚ï¼Œè€Œæ•´ä¸ªå®ä½“é•¿åº¦ä¸º200ä¸ªå­—èŠ‚ã€‚

ç»¼ä¸Šæ‰€è¿°ï¼Œæ–‡ä»¶æ–­ç‚¹ç»­ä¼ éœ€è¦ä½¿ç”¨HTTPåè®®çš„è¯·æ±‚å¤´å’Œå“åº”å¤´æ¥å®ç°ã€‚å®¢æˆ·ç«¯å‘é€å¸¦æœ‰Rangeè¯·æ±‚å¤´çš„è¯·æ±‚ï¼Œè€ŒæœåŠ¡å™¨åˆ™é€šè¿‡Accept-Rangeså“åº”å¤´æ¥å‘Šè¯‰å®¢æˆ·ç«¯æ˜¯å¦æ”¯æŒèŒƒå›´è¯·æ±‚ã€‚å¦‚æœæœåŠ¡å™¨æ”¯æŒèŒƒå›´è¯·æ±‚ï¼Œåˆ™è¿”å›å¸¦æœ‰Content-Rangeå“åº”å¤´çš„å®ä½“ï¼›å¦åˆ™ï¼Œè¿”å›æ•´ä¸ªå®ä½“ã€‚

- `Accept-Ranges: bytes` æ˜¯ HTTP å“åº”å¤´ï¼Œç”¨äºå‘Šè¯‰æµè§ˆå™¨æœåŠ¡å™¨æ¥å—èŒƒå›´è¯·æ±‚ï¼Œå³èƒ½å¤Ÿå¤„ç†æ–­ç‚¹ç»­ä¼ ã€‚å¦‚æœæœåŠ¡å™¨åœ¨å“åº”ä¸­åŒ…å«è¿™ä¸ªå¤´ï¼Œé‚£ä¹ˆå°±æ„å‘³ç€è¯¥æœåŠ¡å™¨ä¸Šçš„èµ„æºå¯ä»¥ä½¿ç”¨æ–­ç‚¹ç»­ä¼ æŠ€æœ¯æ¥è¿›è¡Œä¼ è¾“ã€‚

å½“æˆ‘ä»¬éœ€è¦ä¸Šä¼ æˆ–ä¸‹è½½å¤§æ–‡ä»¶æ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°ç½‘ç»œä¸­æ–­æˆ–å…¶ä»–é—®é¢˜ï¼Œå¯¼è‡´æ— æ³•ä¸€æ¬¡æ€§å®Œæˆä¼ è¾“ã€‚æ­¤æ—¶ï¼Œæ–­ç‚¹ç»­ä¼ æŠ€æœ¯å°±éå¸¸æœ‰ç”¨ã€‚å®ƒå…è®¸æˆ‘ä»¬åœ¨ç½‘ç»œä¸­æ–­æˆ–å…¶ä»–é—®é¢˜å‘ç”Ÿæ—¶ï¼Œä»ä¹‹å‰å·²ç»æˆåŠŸä¼ è¾“çš„éƒ¨åˆ†å¼€å§‹ï¼Œç»§ç»­è¿›è¡Œä¼ è¾“ï¼Œè€Œä¸æ˜¯ä»å¤´å¼€å§‹ã€‚

å…·ä½“æ¥è¯´ï¼Œå½“æˆ‘ä»¬åœ¨æµè§ˆå™¨ä¸­ä¸‹è½½æˆ–ä¸Šä¼ ä¸€ä¸ªå¤§æ–‡ä»¶æ—¶ï¼Œå¦‚æœç½‘ç»œä¸­æ–­ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨ä¿å­˜å·²ç»ä¸‹è½½æˆ–ä¸Šä¼ çš„éƒ¨åˆ†ï¼Œå¹¶åœ¨ç½‘ç»œæ¢å¤åç»§ç»­ä¸‹è½½æˆ–ä¸Šä¼ å‰©ä½™çš„éƒ¨åˆ†ã€‚è¿™å°±æ˜¯åˆ©ç”¨äº† `Accept-Ranges: bytes` å“åº”å¤´å®ç°çš„æ–­ç‚¹ç»­ä¼ æŠ€æœ¯ã€‚

ä»¥ä¸Šä¿¡æ¯ä»…ä¾›å‚è€ƒï¼Œå¯ä»¥æŸ¥é˜…ä¸“ä¸šçš„æŠ€æœ¯æ–‡æ¡£è·å–æ›´å‡†ç¡®æ›´å…¨é¢çš„ä¿¡æ¯ã€‚

- æ–­ç‚¹ç»­ä¼ ä¸­æµè§ˆå™¨ç«¯çš„rangeçš„startå’Œendå¦‚ä½•åŠ¨æ€ç¡®å®š æ–‡ä»¶æ€»å¤§å°å¦‚ä½•ç¡®å®šï¼š
åœ¨æ–­ç‚¹ç»­ä¼ ä¸­ï¼Œæµè§ˆå™¨ç«¯çš„Rangeå¤´ä¸éœ€è¦æ‰‹åŠ¨è®¾ç½®ï¼Œæµè§ˆå™¨ç«¯çš„Rangeå¤´çš„startå’Œendçš„ç¡®å®šé€šå¸¸æ˜¯ç”±æµè§ˆå™¨è‡ªåŠ¨å®Œæˆçš„ã€‚å½“ç”¨æˆ·é€‰æ‹©è¦ä¸‹è½½çš„æ–‡ä»¶æ—¶ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨è®¡ç®—å‡ºæ–‡ä»¶çš„æ€»å¤§å°ï¼Œå¹¶å°†Rangeå¤´çš„startè®¾ç½®ä¸º0ï¼Œendè®¾ç½®ä¸ºæ–‡ä»¶çš„æ€»å¤§å°å‡å»1ã€‚è¿™æ ·ï¼Œæµè§ˆå™¨å°±å¯ä»¥ä»æ–‡ä»¶çš„å¼€å¤´å¼€å§‹ä¸‹è½½ï¼Œä¸€ç›´ä¸‹è½½åˆ°æ–‡ä»¶çš„ç»“å°¾ã€‚

å¦‚æœæ–‡ä»¶å·²ç»éƒ¨åˆ†ä¸‹è½½äº†ï¼Œé‚£ä¹ˆæµè§ˆå™¨ä¼šç»§ç»­ä»å·²ä¸‹è½½éƒ¨åˆ†çš„ä¸‹ä¸€ä¸ªå­—èŠ‚å¼€å§‹ä¸‹è½½ï¼Œè€Œä¸æ˜¯é‡æ–°å¼€å§‹ä¸‹è½½æ•´ä¸ªæ–‡ä»¶ã€‚è¿™æ ·å¯ä»¥èŠ‚çœæ—¶é—´å’Œæµé‡ã€‚

å½“æœåŠ¡å™¨è¿”å›å“åº”æ—¶ï¼Œæµè§ˆå™¨ä¼šæ£€æŸ¥å“åº”å¤´ä¸­çš„Content-Rangeå­—æ®µï¼Œä»¥ç¡®å®šå·²ä¸‹è½½çš„å­—èŠ‚èŒƒå›´å’Œæ–‡ä»¶çš„æ€»å¤§å°ã€‚è¿™æ ·ï¼Œæµè§ˆå™¨å°±å¯ä»¥æ ¹æ®è¿™äº›ä¿¡æ¯åŠ¨æ€è°ƒæ•´Rangeå¤´çš„startå’Œendå€¼ï¼Œä»¥ä¾¿åœ¨åç»­çš„è¯·æ±‚ä¸­ç»§ç»­ä¸‹è½½å‰©ä½™çš„éƒ¨åˆ†ã€‚

æ€»ä¹‹ï¼Œæµè§ˆå™¨ç«¯çš„Rangeå¤´çš„startå’Œendçš„ç¡®å®šæ˜¯ç”±æµè§ˆå™¨è‡ªåŠ¨å®Œæˆçš„ï¼Œè€Œæ–‡ä»¶æ€»å¤§å°çš„ç¡®å®šåˆ™æ˜¯ç”±æœåŠ¡å™¨è¿”å›çš„Content-Rangeå“åº”å¤´æä¾›çš„ã€‚

- åœ¨æ–­ç‚¹ç»­ä¼ ä¸­ï¼Œæµè§ˆå™¨ç«¯é€šå¸¸ä¼šåœ¨ä»¥ä¸‹æƒ…å†µä¸‹æ¸…ç©ºæœ¬åœ°æœªä¸‹è½½å®Œæˆçš„æ–‡ä»¶ï¼š

1. æ–‡ä»¶ä¸‹è½½ä¸­æ–­ï¼šå¦‚æœæ–‡ä»¶ä¸‹è½½è¿‡ç¨‹ä¸­å‡ºç°ä¸­æ–­ï¼Œæµè§ˆå™¨å¯èƒ½ä¼šæ¸…ç©ºæœ¬åœ°æœªä¸‹è½½å®Œæˆçš„æ–‡ä»¶ï¼Œä»¥ä¾¿é‡æ–°å¼€å§‹ä¸‹è½½ã€‚
2. æ–‡ä»¶å¤§å°å˜æ›´ï¼šå¦‚æœæ–‡ä»¶çš„å¤§å°å‘ç”Ÿäº†å˜æ›´ï¼Œä¾‹å¦‚æ–‡ä»¶è¢«æ›´æ–°æˆ–å¢åŠ äº†ä¸€äº›å†…å®¹ï¼Œæµè§ˆå™¨å¯èƒ½ä¼šæ¸…ç©ºæœ¬åœ°æœªä¸‹è½½å®Œæˆçš„æ–‡ä»¶ï¼Œä»¥ä¾¿é‡æ–°å¼€å§‹ä¸‹è½½æ–°çš„æ–‡ä»¶ã€‚
3. æµè§ˆå™¨å…³é—­ï¼šå¦‚æœæµè§ˆå™¨å…³é—­æˆ–é‡æ–°å¯åŠ¨ï¼Œæµè§ˆå™¨å¯èƒ½ä¼šæ¸…ç©ºæœ¬åœ°æœªä¸‹è½½å®Œæˆçš„æ–‡ä»¶ï¼Œä»¥ä¾¿ä¸‹æ¬¡æ‰“å¼€æµè§ˆå™¨æ—¶é‡æ–°å¼€å§‹ä¸‹è½½ã€‚

æ€»ä¹‹ï¼Œæµè§ˆå™¨ç«¯æ¸…ç©ºæœ¬åœ°æœªä¸‹è½½å®Œæˆçš„æ–‡ä»¶é€šå¸¸æ˜¯ä¸ºäº†ä¿è¯ä¸‹è½½çš„æ­£ç¡®æ€§å’Œå®Œæ•´æ€§ã€‚å¦‚æœä¸‹è½½è¿‡ç¨‹ä¸­å‡ºç°äº†é—®é¢˜æˆ–è€…æ–‡ä»¶çš„å¤§å°å‘ç”Ÿäº†å˜æ›´ï¼Œæµè§ˆå™¨ä¼šæ¸…ç©ºæœ¬åœ°æœªä¸‹è½½å®Œæˆçš„æ–‡ä»¶ï¼Œä»¥ä¾¿é‡æ–°å¼€å§‹ä¸‹è½½ã€‚

### æ–‡ä»¶æ–­ç‚¹ç»­ä¼ ï¼šä¸Šä¼ 
- https://juejin.cn/post/6844904046436843527
æ–‡ä»¶æ–­ç‚¹ç»­ä¼ åœ¨ä¸Šä¼ æ—¶çš„å·¥ä½œåŸç†å¦‚ä¸‹ï¼š

1. å®¢æˆ·ç«¯å°†æ–‡ä»¶åˆ’åˆ†ä¸ºå¤šä¸ªåˆ†å—ï¼ˆchunkï¼‰ï¼Œå¹¶ä½¿ç”¨HTTPåè®®é€ä¸ªä¸Šä¼ è¿™äº›åˆ†å—ã€‚
2. å¯¹äºæ¯ä¸ªåˆ†å—ï¼Œå®¢æˆ·ç«¯éƒ½ä¼šè®°å½•ä¸Šä¼ çš„è¿›åº¦ã€‚å¦‚æœä¸Šä¼ è¿‡ç¨‹ä¸­å‡ºç°ä¸­æ–­ï¼Œå®¢æˆ·ç«¯å¯ä»¥é‡æ–°ä¸Šä¼ æœªå®Œæˆçš„éƒ¨åˆ†ã€‚
3. å½“æ‰€æœ‰çš„åˆ†å—éƒ½ä¸Šä¼ å®Œæˆæ—¶ï¼Œå®¢æˆ·ç«¯ä¼šé€šçŸ¥æœåŠ¡å™¨åˆå¹¶è¿™äº›åˆ†å—ã€‚æœåŠ¡å™¨ä¼šæ ¹æ®è®°å½•çš„è¿›åº¦ä¿¡æ¯å°†æ‰€æœ‰çš„åˆ†å—åˆå¹¶ä¸ºä¸€ä¸ªå®Œæ•´çš„æ–‡ä»¶ã€‚

æ–­ç‚¹ç»­ä¼ åœ¨ä¸Šä¼ æ—¶ä¸»è¦åº”ç”¨äº†åˆ†ç‰‡ä¸Šä¼ çš„æŠ€æœ¯ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨åˆ†ç‰‡ä¸Šä¼ çš„åœºæ™¯éƒ½å¯ä»¥ä½¿ç”¨æ–­ç‚¹ç»­ä¼ ã€‚å…·ä½“æ¥è¯´ï¼Œå®¢æˆ·ç«¯å°†æ–‡ä»¶åˆ’åˆ†ä¸ºå¤šä¸ªåˆ†ç‰‡ï¼Œå¹¶é€ä¸ªä¸Šä¼ è¿™äº›åˆ†ç‰‡ã€‚åœ¨ä¸Šä¼ è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæŸä¸ªåˆ†ç‰‡ä¸Šä¼ å¤±è´¥æˆ–ç½‘ç»œä¸­æ–­ï¼Œå®¢æˆ·ç«¯ä¼šè®°å½•å·²ç»ä¸Šä¼ çš„åˆ†ç‰‡æ•°æ®å’Œå½“å‰çš„ä¸Šä¼ è¿›åº¦ã€‚å½“å®¢æˆ·ç«¯é‡æ–°è¿æ¥åˆ°æœåŠ¡å™¨åï¼Œå¯ä»¥ç»§ç»­ä»æœ€åä¸€ä¸ªå·²ä¸Šä¼ çš„åˆ†ç‰‡å¼€å§‹ä¸Šä¼ ï¼Œè€Œä¸éœ€è¦é‡æ–°ä¸Šä¼ æ•´ä¸ªæ–‡ä»¶ã€‚

ä¸ºäº†æ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼ŒæœåŠ¡å™¨ç«¯ä¹Ÿéœ€è¦æä¾›ç›¸åº”çš„æ¥å£æ¥æŸ¥è¯¢å·²ç»ä¸Šä¼ çš„åˆ†ç‰‡æ•°æ®ã€‚è¿™æ ·ï¼Œå®¢æˆ·ç«¯å¯ä»¥çŸ¥é“å·²ç»ä¸Šä¼ çš„åˆ†ç‰‡æ•°æ®ï¼Œä»è€Œä»ä¸‹ä¸€ä¸ªåˆ†ç‰‡æ•°æ®å¼€å§‹ç»§ç»­ä¸Šä¼ ã€‚(ç”±äºå½“æ–‡ä»¶åˆ‡ç‰‡ä¸Šä¼ åï¼ŒæœåŠ¡ç«¯ä¼šå»ºç«‹ä¸€ä¸ªæ–‡ä»¶å¤¹å­˜å‚¨æ‰€æœ‰ä¸Šä¼ çš„åˆ‡ç‰‡ï¼Œæ‰€ä»¥æ¯æ¬¡å‰ç«¯ä¸Šä¼ å‰å¯ä»¥è°ƒç”¨ä¸€ä¸ªæ¥å£ï¼ŒæœåŠ¡ç«¯å°†å·²ä¸Šä¼ çš„åˆ‡ç‰‡çš„åˆ‡ç‰‡åè¿”å›ï¼Œå‰ç«¯å†è·³è¿‡è¿™äº›å·²ç»ä¸Šä¼ åˆ‡ç‰‡ï¼Œè¿™æ ·å°±å®ç°äº†â€œç»­ä¼ â€çš„æ•ˆæœ)

æ€»ä¹‹ï¼Œæ–‡ä»¶æ–­ç‚¹ç»­ä¼ åœ¨ä¸Šä¼ æ—¶é€šè¿‡å°†æ–‡ä»¶åˆ’åˆ†ä¸ºå¤šä¸ªåˆ†å—å¹¶é€ä¸ªä¸Šä¼ çš„æ–¹å¼ï¼Œå®ç°äº†åœ¨ä¸Šä¼ ä¸­æ–­åèƒ½å¤Ÿç»§ç»­ä¸Šä¼ è€Œä¸éœ€è¦é‡æ–°å¼€å§‹æ•´ä¸ªä¸Šä¼ è¿‡ç¨‹çš„åŠŸèƒ½ã€‚

### æ–­ç‚¹ç»­ä¼ ï¼šæ€»ç»“
  - ä¸‹è½½ï¼šæ–­ç‚¹ç»­ä¼ ï¼š
    - æ–­ç‚¹ç»­ä¼ ä¸­, æµè§ˆå™¨ç«¯è¯·æ±‚ä¼šè‡ªåŠ¨æºå¸¦head.Range
    - æœåŠ¡ç«¯ä¼šåˆ¤æ–­å¦‚æœæœ‰request.head.Range, åˆ™ä¼šè¿”å› `Accept-Ranges: bytes` + `Content-Range: bytes 0-1/200`æ¥å‘Šè¯‰æµè§ˆå™¨ç«¯å¯ä»¥æ–­ç‚¹ç»­ä¼ ï¼Œå¹¶å‘Šè¯‰æµè§ˆå™¨ä¸‹è½½çš„æ–‡ä»¶çš„å¤§å°
  - ä¸Šä¼ ï¼šæ–­ç‚¹ç»­ä¼ ï¼š

# DBè¿æ¥
```
å…¶å®DBæ˜¯ä¸€ä¸ªBSæ¶æ„è®¾è®¡
nodeServerè¿™è¾¹å®‰è£…çš„å„ç§é©±åŠ¨mysql/sequalizeå…¶å®å°±æ˜¯DB-client,
çœŸæ­£çš„DB-serverå°±æ˜¯åœ¨æœåŠ¡å™¨ä¸Šçš„server
```
## mysql
- mysql:SQL
- ORM:sequelize
- æå‰çº¦å®šçš„ç»“æ„åŒ–çš„æ•°æ®ï¼šUserç­‰è¡¨
- å…³é”®æ¦‚å¿µï¼š
  - è¿æ¥æ± pool
  - å®šä¹‰schema
  - ç”Ÿæˆmodel
  - å¢
  - åˆ 
  - æ”¹
  - æŸ¥: find
## mongoDB
- mongodb
- ODM: mongoose
- æ–‡æ¡£/è¯„è®º
## redis
- redis
# error
- åœ¨koaçš„æ¥å£routeæˆ–è€…middlwareä¸­ä½¿ç”¨, ä¼šè§¦å‘ä¸­é—´ä»¶è°ƒåº¦æœºåˆ¶ä¸­çš„å¤„ç†ï¼Œä¸­æ–­æµç¨‹ï¼Œä¾‹å¦‚ï¼škoa.on('error')
```js
next(new Error('error info'))
```
# tips
1. app.use(router.allowedMethods())æœ‰ä»€ä¹ˆä½œç”¨
`app.use(router.allowedMethods())`çš„ä½œç”¨æ˜¯å‘Koaåº”ç”¨æ·»åŠ ä¸€ä¸ªä¸­é—´ä»¶ï¼Œè¯¥ä¸­é—´ä»¶ä¼šæ£€æŸ¥HTTPè¯·æ±‚æ–¹æ³•æ˜¯å¦è¢«è·¯ç”±å®šä¹‰æ‰€å…è®¸ã€‚
åœ¨Koaæ¡†æ¶ä¸­ï¼Œæ¯ä¸ªè·¯ç”±å¯ä»¥å®šä¹‰ä¸€ä¸ªæˆ–å¤šä¸ªå…è®¸çš„HTTPè¯·æ±‚æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªè·¯ç”±å¯èƒ½åªå…è®¸GETè¯·æ±‚ï¼Œè€Œå¦ä¸€ä¸ªè·¯ç”±å¯èƒ½å…è®¸GETå’ŒPOSTè¯·æ±‚ã€‚`router.allowedMethods()`æ–¹æ³•è¿”å›ä¸€ä¸ªä¸­é—´ä»¶ï¼Œè¯¥ä¸­é—´ä»¶å°†æ£€æŸ¥å½“å‰è¯·æ±‚çš„HTTPæ–¹æ³•æ˜¯å¦ä¸è·¯ç”±å®šä¹‰çš„æ–¹æ³•åŒ¹é…ã€‚
é€šè¿‡å°†`app.use(router.allowedMethods())`æ·»åŠ åˆ°Koaåº”ç”¨çš„ä¸­é—´ä»¶å †æ ˆä¸­ï¼Œæˆ‘ä»¬ç¡®ä¿åœ¨å°è¯•è®¿é—®ä¸€ä¸ªä¸å…è®¸çš„HTTPæ–¹æ³•çš„è·¯ç”±æ—¶ï¼ŒKoaå°†è¿”å›ä¸€ä¸ª405æ–¹æ³•ä¸å…è®¸çš„é”™è¯¯å“åº”ã€‚è¿™æœ‰åŠ©äºä¿æŠ¤æˆ‘ä»¬çš„åº”ç”¨ï¼Œç¡®ä¿åªå…è®¸é€‚å½“çš„HTTPæ–¹æ³•è®¿é—®æ¯ä¸ªè·¯ç”±ã€‚
2. koa-routerå¦‚ä½•å®šä¹‰å“ªäº›httpè¯·æ±‚æ–¹æ³•è¢«å…è®¸
åœ¨Koa-routerä¸­ï¼Œä½ å¯ä»¥é€šè¿‡åœ¨è·¯ç”±å®šä¹‰ä¸­æŒ‡å®š`methods`å±æ€§æ¥å®šä¹‰å“ªäº›HTTPè¯·æ±‚æ–¹æ³•è¢«å…è®¸ã€‚`methods`å±æ€§æ˜¯ä¸€ä¸ªæ•°ç»„ï¼ŒåŒ…å«å…è®¸çš„HTTPè¯·æ±‚æ–¹æ³•ã€‚
```javascript
const Router = require('koa-router');

const router = new Router();

// åªå…è®¸GETè¯·æ±‚è®¿é—®è¯¥è·¯ç”±
router.get('/allowed-get', { methods: ['GET'] }, (ctx, next) => {
  ctx.body = 'This route is allowed for GET requests.';
  next();
});

// åªå…è®¸POSTè¯·æ±‚è®¿é—®è¯¥è·¯ç”±
router.post('/allowed-post', { methods: ['POST'] }, (ctx, next) => {
  ctx.body = 'This route is allowed for POST requests.';
  next();
});
```
